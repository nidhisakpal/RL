# Output Display Improvements Summary

## Completed Enhancements

This document summarizes the improvements made to the HTML visualization output generated by `simulate.c`.

### 1. MIP Gap Tolerance Reporting âœ“

**Implementation:**
- Updated `parse_final_mip_gap()` function to correctly parse the `% @2` line from solution files
- Fixed calculation to use absolute value: `|100 - reduction| / 100.0`
- Handles edge cases where reduction > 100 (e.g., 100.0038 due to rounding)

**Display:**
```
MIP Gap: 0.0038% (0.000038)
```

**Location:** Main metrics table in HTML output

---

### 2. Total Cost Display âœ“

**Implementation:**
- Updated `parse_solution_cost()` function to parse the final "Euclidean SMT" line
- Format: `(Euclidean SMT:  N points,  length = X.XXX,  T.TT seconds)`
- Fixed to allow negative costs (battery rewards can dominate tree costs)

**Display:**
```
Total Cost: -0.000113
```

**Note:** Negative costs indicate battery rewards are larger than normalized tree costs, which is expected behavior.

**Location:** Main metrics table in HTML output

---

### 3. Budget Usage Display âœ“

**Implementation:**
- Added `parse_budget_usage()` function to extract budget information
- Parses line: `DEBUG IFS: Budget mode - solution with X edges covering Y vertices uses budget A.BBB/C.CCC`
- Calculates budget utilization percentage

**Display:**
```
Budget Used: 1.758 / 1.800 (97.7%)
```

**Location:** Main metrics table in HTML output

---

### 4. Cost Breakdown Table âœ“

**Implementation:**
- Added new "Cost Breakdown" section after main metrics
- Displays all optimization parameters
- Includes explanatory text for the objective function formula

**Display:**
```
ðŸ’° Cost Breakdown

Parameter               Value
Alpha (Î±)              50.0
Beta (Î²)               0.0 (disabled)
Budget Constraint      1.800
Total Objective        -0.000113

Total = Î£[tree_cost/diagonal + Î£_terminals(Î±Ã—(-1+battery/100))]Ã—x
Negative cost indicates battery rewards dominating tree costs
```

**Location:** New section after main metrics, before legend

---

### 5. Updated Formulation in HTML âœ“

**Implementation:**
- Removed beta references from objective function
- Updated to show per-terminal battery reward formulation
- Added graph diagonal normalization explanation
- Updated budget constraint to show actual parsed values
- Added "Battery Reward Design" section with example values

**New Objective Function:**
```
Minimize: Î£[tree_cost[i]/diagonal + Î£â±¼âˆˆFST[i] Î±Ã—(-1 + battery[j]/100)]Ã—x[i]

Where:
- Î± = 50.0 (battery reward weight)
- Î² = 0.0 (disabled - battery rewards replace penalty)
- diagonal = âˆš(widthÂ² + heightÂ²) of terminal bounding box
- Battery rewards: Each terminal contributes Î±Ã—(-1 + battery/100) to FST cost
- NOT covering a 1% battery terminal â‰ˆ losing -49.5 reward (implicit +49.5 penalty)
```

**Updated Constraints:**
```
1. Budget Constraint: Î£ (tree_cost[i] / diagonal) Ã— x[i] â‰¤ 1.800
2. Soft Spanning Constraint: Î£(|FST[i]| - 1) Ã— x[i] + Î£not_covered[j] = 19
3. Soft Cutset Constraints: For each terminal j: Î£(x[i]: FST i covers j) + not_covered[j] â‰¥ 1
4. Source Coverage: not_covered[0] = 0 (source terminal always covered)
5. Variable Bounds: x[i] âˆˆ {0,1}, not_covered[j] âˆˆ [0,1]
```

**Battery Reward Design Examples:**
```
â€¢ 0% battery  â†’ -50.0 reward (strong incentive to cover)
â€¢ 1% battery  â†’ -49.5 reward (very strong incentive)
â€¢ 50% battery â†’ -25.0 reward (moderate incentive)
â€¢ 100% battery â†’ 0.0 reward (no incentive)
```

**Location:** "Technical Implementation Details" section at bottom of HTML

---

## Files Modified

### simulate.c

**New Functions:**
- `parse_budget_usage()` - Extracts budget used and budget limit from solution file

**Modified Functions:**
- `parse_final_mip_gap()` - Fixed to use absolute value for gap calculation
- `parse_solution_cost()` - Updated to parse final "Euclidean SMT" line and allow negative costs
- `create_rich_visualization()` - Added cost breakdown table and updated formulation section

**Key Changes:**
1. Line 84: Added `parse_budget_usage()` function declaration
2. Line 852: Changed cost validation to allow negative costs: `if (solution_cost >= -1000.0 && solution_cost != -1.0)`
3. Line 856-862: Added budget usage parsing and display
4. Line 867-888: Added cost breakdown table section
5. Line 938-945: Updated budget constraint display to use parsed values
6. Line 989-1018: Updated objective function and constraint formulation
7. Line 1344: Fixed MIP gap calculation to use absolute value
8. Line 1363-1368: Updated solution cost parser to find "Euclidean SMT" line
9. Line 1374-1399: Added `parse_budget_usage()` implementation

---

## Testing

**Test Command:**
```bash
./simulate -t results2/terminals_iter1.txt \
           -f results2/fsts_iter1.txt \
           -r results2/solution_iter1.txt \
           -w test_updated_viz.html
```

**Verified Output:**
- âœ“ MIP Gap: 0.0038% (0.000038)
- âœ“ Total Cost: -0.000113
- âœ“ Budget Used: 1.758 / 1.800 (97.7%)
- âœ“ Cost Breakdown table with all parameters
- âœ“ Updated formulation without beta references
- âœ“ Battery reward design examples

---

## Key Design Decisions

1. **Negative Cost Handling:** Changed validation from `>= 0.0` to `>= -1000.0 && != -1.0` to allow negative objective values while still detecting parse failures (-1.0)

2. **MIP Gap Absolute Value:** Used `|100 - reduction|` instead of `100 - reduction` to handle cases where reduction slightly exceeds 100 due to floating-point rounding

3. **Cost Display Precision:**
   - Total cost: 6 decimal places (e.g., -0.000113)
   - Budget: 3 decimal places (e.g., 1.758 / 1.800)
   - MIP gap: 4 decimal places percentage + 6 decimal places fractional

4. **Beta Documentation:** Clearly marked as "0.0 (disabled)" with explanation that battery rewards replace the penalty mechanism

---

## Impact

These improvements provide:

1. **Better visibility** into optimization quality (MIP gap)
2. **Complete cost information** including negative objective values
3. **Budget utilization tracking** to verify constraint satisfaction
4. **Clear parameter documentation** for reproducibility
5. **Accurate mathematical formulation** reflecting the actual implementation

All changes are backward compatible and handle missing data gracefully (showing "Not available" when parse fails).
